<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Drive CLI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', Courier, monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* „ÉÜ„Éº„ÉûÂ§âÊï∞ */
    body[data-theme="dark"] {
      background-color: #1e1e1e;
      color: #d4d4d4;
    }

    body[data-theme="light"] {
      background-color: #ffffff;
      color: #000000;
    }

    /* „Éò„ÉÉ„ÉÄ„Éº */
    .header {
      padding: 10px 20px;
      border-bottom: 1px solid;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: background-color 0.3s;
    }

    body[data-theme="dark"] .header {
      background-color: #2d2d30;
      border-bottom-color: #3e3e42;
    }

    body[data-theme="light"] .header {
      background-color: #f5f5f5;
      border-bottom-color: #ddd;
    }

    .header h1 {
      font-size: 14px;
      font-weight: normal;
    }

    body[data-theme="dark"] .header h1 {
      color: #cccccc;
    }

    body[data-theme="light"] .header h1 {
      color: #333;
    }

    .status {
      margin-left: auto;
      font-size: 12px;
    }

    body[data-theme="dark"] .status {
      color: #858585;
    }

    body[data-theme="light"] .status {
      color: #666;
    }

    .theme-toggle {
      cursor: pointer;
      font-size: 20px;
      padding: 5px;
      user-select: none;
    }

    /* „Çø„Éº„Éü„Éä„É´Âá∫Âäõ„Ç®„É™„Ç¢ */
    .terminal {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
    }

    .terminal::-webkit-scrollbar {
      width: 10px;
    }

    body[data-theme="dark"] .terminal::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    body[data-theme="light"] .terminal::-webkit-scrollbar-track {
      background: #f5f5f5;
    }

    body[data-theme="dark"] .terminal::-webkit-scrollbar-thumb {
      background: #424242;
      border-radius: 5px;
    }

    body[data-theme="light"] .terminal::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 5px;
    }

    /* Âá∫ÂäõË°å */
    .output-line {
      margin-bottom: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .prompt {
      font-weight: bold;
    }

    body[data-theme="dark"] .prompt {
      color: #4ec9b0;
    }

    body[data-theme="light"] .prompt {
      color: #008080;
    }

    .command {
      color: #dcdcaa;
    }

    body[data-theme="light"] .command {
      color: #795e26;
    }

    .result {
      margin-left: 0;
    }

    .error {
      color: #f48771;
    }

    body[data-theme="light"] .error {
      color: #cd3131;
    }

    .success {
      color: #b5cea8;
    }

    body[data-theme="light"] .success {
      color: #008000;
    }

    /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
    .input-container {
      border-top: 1px solid;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.3s;
    }

    body[data-theme="dark"] .input-container {
      background-color: #252526;
      border-top-color: #3e3e42;
    }

    body[data-theme="light"] .input-container {
      background-color: #f9f9f9;
      border-top-color: #ddd;
    }

    .input-prompt {
      font-weight: bold;
      flex-shrink: 0;
    }

    body[data-theme="dark"] .input-prompt {
      color: #4ec9b0;
    }

    body[data-theme="light"] .input-prompt {
      color: #008080;
    }

    #commandInput {
      flex: 1;
      border: 1px solid;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      padding: 8px 12px;
      outline: none;
      border-radius: 3px;
      transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
    }

    body[data-theme="dark"] #commandInput {
      background-color: #3c3c3c;
      border-color: #3e3e42;
      color: #d4d4d4;
    }

    body[data-theme="light"] #commandInput {
      background-color: #ffffff;
      border-color: #ccc;
      color: #000;
    }

    body[data-theme="dark"] #commandInput:focus {
      border-color: #007acc;
      box-shadow: 0 0 0 1px #007acc;
    }

    body[data-theme="light"] #commandInput:focus {
      border-color: #0078d4;
      box-shadow: 0 0 0 1px #0078d4;
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
    .loading {
      display: inline-block;
    }

    body[data-theme="dark"] .loading {
      color: #858585;
    }

    body[data-theme="light"] .loading {
      color: #666;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏ */
    .welcome {
      margin-bottom: 20px;
      border-left: 3px solid;
      padding-left: 15px;
    }

    body[data-theme="dark"] .welcome {
      color: #858585;
      border-left-color: #007acc;
    }

    body[data-theme="light"] .welcome {
      color: #666;
      border-left-color: #0078d4;
    }

    .welcome strong {
      color: #4ec9b0;
    }

    body[data-theme="light"] .welcome strong {
      color: #008080;
    }

    /* „Ç´„É©„Éº„É¢„Éº„ÉâÁî®„ÇØ„É©„Çπ */
    .color-white { color: #ffffff !important; }
    .color-blue { color: #4a9eff !important; }
    .color-green { color: #4ec9b0 !important; }
    .color-red { color: #f48771 !important; }
    .color-yellow { color: #dcdcaa !important; }
    .color-cyan { color: #4fc1ff !important; }
    .color-magenta { color: #c586c0 !important; }
    .color-black { color: #000000 !important; }
  </style>
</head>
<body data-theme="dark">
  <div class="header">
    <h1>üìÅ Google Drive CLI</h1>
    <span class="theme-toggle" id="themeToggle" title="Toggle theme">üåì</span>
    <div class="status" id="status">Ready</div>
  </div>

  <div class="terminal" id="terminal">
    <div class="welcome">
      <strong>Google Drive Command Line Interface</strong><br>
      Type <strong>help</strong> to see available commands.<br>
      Current directory: <span id="currentPath">/</span>
    </div>
  </div>

  <div class="input-container">
    <span class="input-prompt" id="inputPrompt">drive@root:~$</span>
    <input 
      type="text" 
      id="commandInput" 
      placeholder="Enter command..." 
      autocomplete="off"
      spellcheck="false"
    >
  </div>

  <script>
    // =====================================
    // State Management
    // =====================================
    
    const state = {
      commandHistory: [],
      historyIndex: -1,
      isProcessing: false,
      currentPath: '/',
      theme: 'dark',
      textColor: null
    };

    // =====================================
    // DOM Elements
    // =====================================
    
    const terminal = document.getElementById('terminal');
    const commandInput = document.getElementById('commandInput');
    const statusEl = document.getElementById('status');
    const themeToggle = document.getElementById('themeToggle');
    const inputPrompt = document.getElementById('inputPrompt');
    const currentPathEl = document.getElementById('currentPath');

    // =====================================
    // Theme Management
    // =====================================
    
    function toggleTheme() {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', state.theme);
      localStorage.setItem('theme', state.theme);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        state.theme = savedTheme;
        document.body.setAttribute('data-theme', state.theme);
      }
    }

    themeToggle.addEventListener('click', toggleTheme);
    loadTheme();

    // =====================================
    // Event Handlers
    // =====================================
    
    commandInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleCommand();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateHistory('up');
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateHistory('down');
      } else if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        handleInterrupt();
      }
    });

    window.addEventListener('click', () => {
      if (!state.isProcessing) {
        commandInput.focus();
      }
    });

    commandInput.focus();

    // =====================================
    // Core Functions
    // =====================================
    
    function handleCommand() {
      const command = commandInput.value.trim();
      
      if (!command) return;
      if (state.isProcessing) return;
      
      state.commandHistory.push(command);
      state.historyIndex = state.commandHistory.length;
      
      appendOutput(`<span class="prompt">${escapeHtml(inputPrompt.textContent)}</span> <span class="command">${escapeHtml(command)}</span>`);
      
      commandInput.value = '';
      commandInput.disabled = true;
      state.isProcessing = true;
      updateStatus('Processing...');
      
      const loadingId = appendOutput('<span class="loading">Executing</span>', true);
      
      google.script.run
        .withSuccessHandler((result) => handleSuccess(result, loadingId))
        .withFailureHandler((error) => handleError(error, loadingId))
        .processCommand(command);
    }

    function handleSuccess(result, loadingId) {
      removeOutput(loadingId);
      
      // „Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ
      if (result.action) {
        switch (result.action) {
          case 'clear':
            terminal.innerHTML = '';
            resetInput();
            return;
          
          case 'reload':
            location.reload();
            return;
          
          case 'exit':
            appendOutput(`<span class="success">${escapeHtml(result.output)}</span>`);
            setTimeout(() => window.close(), 1000);
            return;
          
          case 'color':
            state.textColor = result.color;
            appendOutput(`<span class="success">${escapeHtml(result.output)}</span>`);
            resetInput();
            return;
          
          case 'open':
            window.open(result.output, '_blank');
            appendOutput(`<span class="success">Opening in new tab...</span>`);
            resetInput();
            return;
        }
      }
      
      const className = result.success ? 'success' : 'error';
      let outputHtml = `<span class="${className}">${escapeHtml(result.output)}</span>`;
      
      if (state.textColor) {
        outputHtml = `<span class="color-${state.textColor}">${escapeHtml(result.output)}</span>`;
      }
      
      appendOutput(outputHtml);
      
      updatePrompt();
      resetInput();
    }

    function handleError(error, loadingId) {
      removeOutput(loadingId);
      appendOutput(`<span class="error">System Error: ${escapeHtml(error.message)}</span>`);
      resetInput();
    }

    function handleInterrupt() {
      if (state.isProcessing) {
        appendOutput(`<span class="error">^C (interrupted - note: cannot stop GAS execution)</span>`);
      } else {
        appendOutput(`<span class="error">^C</span>`);
        commandInput.value = '';
      }
    }

    function resetInput() {
      commandInput.disabled = false;
      commandInput.focus();
      state.isProcessing = false;
      updateStatus('Ready');
    }

    function updatePrompt() {
      google.script.run
        .withSuccessHandler((path) => {
          state.currentPath = path;
          currentPathEl.textContent = path;
          const dirName = path === '/' ? 'root' : path.split('/').pop();
          inputPrompt.textContent = `drive@${dirName}:~$`;
        })
        .getCurrentPath();
    }

    // =====================================
    // History Navigation
    // =====================================
    
    function navigateHistory(direction) {
      if (state.commandHistory.length === 0) return;
      
      if (direction === 'up') {
        if (state.historyIndex > 0) {
          state.historyIndex--;
          commandInput.value = state.commandHistory[state.historyIndex];
        }
      } else if (direction === 'down') {
        if (state.historyIndex < state.commandHistory.length - 1) {
          state.historyIndex++;
          commandInput.value = state.commandHistory[state.historyIndex];
        } else {
          state.historyIndex = state.commandHistory.length;
          commandInput.value = '';
        }
      }
    }

    // =====================================
    // UI Utilities
    // =====================================
    
    function appendOutput(html, returnsId = false) {
      const div = document.createElement('div');
      div.className = 'output-line';
      div.innerHTML = html;
      
      if (returnsId) {
        const id = 'output-' + Date.now();
        div.id = id;
        terminal.appendChild(div);
        scrollToBottom();
        return id;
      }
      
      terminal.appendChild(div);
      scrollToBottom();
    }

    function removeOutput(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function updateStatus(text) {
      statusEl.textContent = text;
    }

    function scrollToBottom() {
      terminal.scrollTop = terminal.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ÂàùÊúü„Éó„É≠„É≥„Éó„ÉàÊõ¥Êñ∞
    updatePrompt();
  </script>
</body>
</html>